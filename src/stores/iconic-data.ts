import {writable} from "svelte/store";

export type iconicDataType = {
  _: string;
  modules: Array<iconicDataModule>;
};

export type iconicDataModule = {
  key: string;
  raw: string;
  parts: Array<iconicDataPart>;
};

export type iconicDataPart = {
  color: string;
  char: string;
  name: string;
};

export function isIconicDataType(arg: any): arg is iconicDataType {
  if (!arg) throw new Error("Missing arg");
  if (!arg._) throw new Error("Missing arg._");
  if (arg._ !== "Generated by KTaNE Iconic Editor. DO NOT EDIT.") throw new Error("Invalid arg._");
  if (!arg.modules) throw new Error("Missing arg.modules");
  if (!Array.isArray(arg.modules)) throw new Error("Invalid type arg.modules");
  for (let i = 0; i < arg.modules.length; i++) {
    try {
      isIconicDataModule(arg.modules[i]);
    } catch (e) {
      throw new Error("Invalid arg.modules item: " + e);
    }
  }
  if (!isUnique(arg.modules, x => x.key)) throw new Error("Non-unique key in arg.modules");
  return true;
}

function isIconicDataModule(arg: any): arg is iconicDataModule {
  if (!arg.key) throw new Error("Missing arg.key");
  if (typeof arg.key != "string") throw new Error("Invalid type arg.key");
  if (!arg.raw) throw new Error("Missing arg.raw");
  if (typeof arg.raw != "string") throw new Error("Invalid type arg.raw");
  if (!arg.parts) throw new Error("Missing arg.parts");
  if (!Array.isArray(arg.parts)) throw new Error("Invalid type arg.parts");
  for (let i = 0; i < arg.parts.length; i++) {
    try {
      isIconicDataPart(arg.parts[i]);
    } catch (e) {
      throw new Error("Invalid arg.parts item: " + e);
    }
  }
  if (!isUnique(arg.parts, x => x.color)) throw new Error("Non-unique color in arg.parts");
  if (!isUnique(arg.parts, x => x.char)) throw new Error("Non-unique char in arg.parts");
  if (!isUnique(arg.parts, x => x.name)) throw new Error("Non-unique name in arg.parts");
  return true;
}

function isIconicDataPart(arg: any): arg is iconicDataPart {
  if (!arg.color) throw new Error("Missing arg.color");
  if (typeof arg.color != "string") throw new Error("Invalid type arg.color");
  if (!/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(arg.color)) throw new Error("Invalid format arg.color");
  if (!arg.char) throw new Error("Missing arg.char");
  if (typeof arg.char != "string") throw new Error("Invalid type arg.char");
  if (arg.char.length !== 1) throw new Error("Invalid format arg.char");
  if (!arg.name) throw new Error("Missing arg.name");
  if (typeof arg.name != "string") throw new Error("Invalid type arg.name");
  return true;
}

function isUnique(x: Array<any>, f: (x: any) => any): boolean {
  return (
    x.filter((value, index, self) => {
      return self.findIndex(v => f(v) === f(value)) === index;
    }).length === x.length
  );
}

export const iconicData = writable<iconicDataType>({
  _: "Generated by KTaNE Iconic Editor. DO NOT EDIT.",
  modules: [],
});
